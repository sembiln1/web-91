<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9Â¹ | Dashboard & AI</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #0b141a;
            --card-bg: rgba(32, 44, 51, 0.95);
            --accent-color: #00d2ff;
            --ai-color: #00d2ff;
            --me-chat: #005c4b;
            --them-chat: #202c33;
        }

        body { 
            background-color: var(--bg-color); 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            background-attachment: fixed;
            color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; padding-bottom: 90px; user-select: none; 
        }

        .nav-bottom { 
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(20px);
            border-top: 1px solid #333; z-index: 1000;
        }
        .nav-item { color: #888; font-size: 13px; cursor: pointer; text-align: center; flex: 1; transition: 0.3s; font-weight: bold; }
        .nav-item i { display: block; font-size: 26px; margin-bottom: 5px; }
        .nav-item.active { color: var(--accent-color); }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #333; }

        .album-launcher {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            padding: 18px; border-radius: 15px; color: white; cursor: pointer;
            margin-bottom: 20px; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,210,255,0.3);
        }

        .album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px; }
        .album-item { background: #111; border-radius: 12px; overflow: hidden; border: 1px solid #444; }
        .album-item img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .album-item p { font-size: 11px; padding: 8px; margin: 0; text-align: center; color: #bbb; background: #111; }

        #chatBox { height: 55vh; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.4; }
        .msg-me { align-self: flex-end; background: var(--me-chat); border-bottom-right-radius: 2px; }
        .msg-them { align-self: flex-start; background: var(--them-chat); border-bottom-left-radius: 2px; }
        .msg-ai { align-self: flex-start; background: #1f2c33; color: var(--ai-color); border: 1px solid var(--ai-color); border-bottom-left-radius: 2px; }

        .chat-input-area { display: flex; gap: 8px; background: #2a3942; padding: 10px; border-radius: 30px; margin-top: 10px; }
        #chatInput { flex: 1; background: transparent; border: none; color: white; outline: none; padding-left: 10px; font-size: 14px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 12px; font-size: 13px; text-align: left; }
        th { background: #111; color: var(--accent-color); }
        .dot-flashing { display: inline-block; width: 4px; height: 4px; border-radius: 5px; background-color: var(--accent-color); animation: dot-flashing 1s infinite alternate; margin-left: 5px; }
        @keyframes dot-flashing { 0% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div id="h" class="section active-section">
            <div class="card" style="text-align:center;">
                <h2 style="color:var(--accent-color);">9Â¹ Dashboard</h2>
                <p>User: <b id="displayUser">...</b> | <span id="displayRole">Member</span></p>
                <a href="https://www.tiktok.com/@nineeone_freestyle" target="_blank" style="background:#fff; color:#000; display:flex; align-items:center; justify-content:center; gap:10px; padding:12px; border-radius:15px; text-decoration:none; font-weight:bold;">
                    <i class="fab fa-tiktok"></i> Follow Akun TikTok 9Â¹
                </a>
            </div>

            <div id="notifBox" class="card" style="display: none; border: 1px solid #f1c40f;">
                <h3 style="color:#f1c40f; margin-top:0;"><i class="fas fa-bullhorn"></i> Pengumuman</h3>
                <p id="pesanWeb" style="font-size: 14px; white-space: pre-wrap;"></p>
            </div>

            <div class="album-launcher" onclick="openS('a')">
                <span><i class="fas fa-images"></i>Album Kelas</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>

        <div id="a" class="section">
            <button onclick="openS('h')" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-weight:bold; padding:10px 0;">
                <i class="fas fa-arrow-left"></i> Kembali
            </button>
            <div class="card">
                <h3 style="color:var(--accent-color); margin-top:0;">ðŸ“‚ Galeri Foto 9Â¹</h3>
                <div id="albumGrid" class="album-grid">
                    <p style="grid-column: span 2; text-align: center; color: #666;">Memuat...</p>
                </div>
            </div>
        </div>

        <div id="c" class="section">
            <div class="card" style="padding: 10px; background: rgba(11, 20, 26, 0.9);">
                <div id="chatBox"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Ketik /ai [pesan] untuk AI..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" style="background:#00a884; border:none; border-radius:50%; width:40px; height:40px; color:white;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="p" class="section"><div class="card"><h3>ðŸ§¹ Jadwal Piket</h3><table id="tabelPiket"></table></div></div>
        <div id="j" class="section"><div class="card"><h3>ðŸ“š Jadwal Pelajaran</h3><table id="tabelMapel"></table></div></div>
    </div>

    <div class="nav-bottom">
        <div class="nav-item active" onclick="openS('h', this)"><i class="fas fa-home"></i>Home</div>
        <div class="nav-item" onclick="openS('c', this)"><i class="fas fa-comment-dots"></i>Chat</div>
        <div class="nav-item" onclick="openS('p', this)"><i class="fas fa-broom"></i>Piket</div>
        <div class="nav-item" onclick="openS('j', this)"><i class="fas fa-book"></i>Mapel</div>
        <div class="nav-item" onclick="logout()" style="color:#ff4d4d;"><i class="fas fa-sign-out-alt"></i>Out</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDlucMVwMUbw7Ab3t2AVzI13EOHUrqDNZw",
            databaseURL: "https://web-kelas-5b83a-default-rtdb.asia-southeast1.firebasedatabase.app",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const me = localStorage.getItem('savedUser') || "User";
        const bypassUsers = ["admin", "Tya", "9Â¹", "Kontol"];

        // ==========================================
        // FITUR ONLINE PING (SETIAP 5 DETIK)
        // ==========================================
        if (me && me !== "User") {
            const userStatusRef = database.ref('log_online/' + me);
            
            // Ping awal
            userStatusRef.set({
                username: me,
                last_seen: firebase.database.ServerValue.TIMESTAMP
            });

            // Ping ulang setiap 5 detik
            setInterval(() => {
                userStatusRef.update({
                    last_seen: firebase.database.ServerValue.TIMESTAMP
                });
            }, 5000);

            // Hapus saat tab ditutup
            userStatusRef.onDisconnect().remove();
        }

        // Maintenance & Security
        database.ref('maintenance/isLive').on('value', snap => {
            if (snap.val() === true && !bypassUsers.includes(me)) {
                alert("âš ï¸ MAINTENANCE!");
                localStorage.clear(); window.location.replace("index.html");
            }
        });

        const AI_KEY = "AIzaSyDJVXpMxplis6OvWfVjTmrrFMJIxe4D5V4"; 
        const AI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${AI_KEY}`;

        let isAdmin = false;
        database.ref('roles/' + me).on('value', snap => {
            isAdmin = (snap.val() === "admin" || me === "admin");
            document.getElementById('displayUser').innerText = me;
            const r = document.getElementById('displayRole');
            r.innerText = isAdmin ? "Admin" : "Member";
            r.style.color = isAdmin ? "#ff4d4d" : "#00d2ff";
        });

        // Album Logic
        database.ref('album_kelas').on('value', snap => {
            const grid = document.getElementById('albumGrid');
            grid.innerHTML = "";
            if (snap.exists()) {
                snap.forEach(c => {
                    const d = c.val();
                    grid.innerHTML += `<div class="album-item"><img src="${d.url}" onclick="window.open('${d.url}','_blank')"><p>${d.caption || 'Photo'}</p></div>`;
                });
            } else { grid.innerHTML = "<p style='grid-column:span 2;text-align:center;'>Belum ada foto.</p>"; }
        });

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const val = input.value.trim();
            if(!val) return;

            database.ref('chat_kelas').push({ user: me, msg: val, time: Date.now() });
            input.value = "";

            if (val.toLowerCase().startsWith('/ai ')) {
                const prompt = val.substring(4);
                const aiRef = database.ref('chat_kelas').push({ user: "9Â¹GPT", msg: "<i>Mengetik...</i> <span class='dot-flashing'></span>", isAI: true });
                
                try {
                    const res = await fetch(AI_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const resJson = await res.json();
                    let reply = resJson.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                    aiRef.update({ msg: reply });
                } catch (e) { aiRef.update({ msg: "âŒ AI Limit." }); }
            }
        }

        database.ref('chat_kelas').limitToLast(30).on('value', snap => {
            const box = document.getElementById('chatBox');
            box.innerHTML = "";
            snap.forEach(c => {
                const d = c.val();
                const isMe = d.user === me;
                const isAI = d.isAI;
                let cls = isMe ? 'msg-me' : (isAI ? 'msg-ai' : 'msg-them');
                box.innerHTML += `<div class="msg ${cls}">
                    ${!isMe ? `<b style="font-size:10px;display:block;color:#3498db;">${d.user}</b>` : ''}
                    ${d.msg}
                    ${(isAdmin || isMe) ? `<i class="fas fa-trash" style="font-size:10px;margin-left:8px;opacity:0.4;" onclick="database.ref('chat_kelas/${c.key}').remove()"></i>` : ''}
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        function openS(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            if(el) el.classList.add('active');
            if(id === 'c') setTimeout(() => { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }, 100);
        }

        database.ref('konten_web').on('value', snap => {
            const d = snap.val();
            if (d && d.pesan) {
                document.getElementById('notifBox').style.display = 'block';
                document.getElementById('pesanWeb').innerText = d.pesan;
            }
        });

        const listHari = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
        database.ref('data_kelas').on('value', snap => {
            const d = snap.val() || {};
            const p = d.jadwal_piket || {};
            const j = d.jadwal_pelajaran || {};
            document.getElementById('tabelPiket').innerHTML = "<tr><th>Hari</th><th>Piket</th></tr>" + listHari.map(h => `<tr><td><b>${h}</b></td><td>${p[h] || '-'}</td></tr>`).join('');
            document.getElementById('tabelMapel').innerHTML = "<tr><th>Hari</th><th>Mapel</th></tr>" + listHari.map(h => `<tr><td><b>${h}</b></td><td>${j[h] || '-'}</td></tr>`).join('');
        });

        function logout() { 
            if(me !== "User") database.ref('log_online/' + me).remove();
            localStorage.clear(); 
            window.location.replace("index.html"); 
        }
    </script>
</body>
</html>
